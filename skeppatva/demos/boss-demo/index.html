<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Particle Power Boss Demo</title>
  <style>
    body { margin: 0; overflow: hidden; background: #000; font-family: sans-serif; }
    canvas { display: block; }
    #ui { position: absolute; top: 10px; left: 10px; font-size: 18px; background: rgba(0,0,0,0.5); color: white; padding: 10px; border-radius: 8px; z-index: 10; }
    #gameOver, #victory { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); color: white; background: rgba(0,0,0,0.8); padding: 30px; border-radius: 12px; font-size: 36px; display: none; text-align: center; cursor: pointer; z-index: 11; }
  </style>
</head>
<body>
  <div id="ui">
    ❤️ Health: <span id="health">3</span><br>
    🎯 Score: <span id="score">0</span><br>
    🔮 Boss HP: <span id="bossHealth">500</span>
  </div>
  <div id="gameOver">💀 Game Over 💀<br><br>Click to Restart</div>
  <div id="victory">🎉 You Defeated the Boss! 🎉<br><br>Click to Restart</div>

  <script src="https://cdn.jsdelivr.net/npm/three@0.153.0/build/three.min.js"></script>
  <script>
    // Core vars
    let scene, camera, renderer;
    let player, floor, boss;
    let bullets = [], enemyBullets = [];
    let keys = { w:false,a:false,s:false,d:false };
    let velocityY = 0, gravity = -0.02, jumping = false;
    let health=3, score=0, bossHealth=500;
    let canShoot=true, shootCD=250;
    let gameOver=false, victory=false;

    const arenaSize = 25;
    const uiHealth=document.getElementById('health');
    const uiScore=document.getElementById('score');
    const uiBossHP=document.getElementById('bossHealth');
    const gameOverDiv=document.getElementById('gameOver');
    const victoryDiv=document.getElementById('victory');

    // Aiming
    const raycaster=new THREE.Raycaster();
    const mouse=new THREE.Vector2();
    const aimPoint=new THREE.Vector3();

    // Boss attack timers
    let lastShoot=0, lastDash=0, lastSpin=0;

    function init(){
      scene=new THREE.Scene();
      camera=new THREE.PerspectiveCamera(75,window.innerWidth/window.innerHeight,0.1,1000);
      camera.position.set(0,5,12);
      camera.lookAt(0,0,0);

      renderer=new THREE.WebGLRenderer({antialias:true});
      renderer.setSize(window.innerWidth,window.innerHeight);
      document.body.appendChild(renderer.domElement);

      // Lights
      const light=new THREE.DirectionalLight(0xffffff,1);
      light.position.set(5,10,7);
      scene.add(light,new THREE.AmbientLight(0x404040));

      // Floor
      floor=new THREE.Mesh(
        new THREE.PlaneGeometry(50,50),
        new THREE.MeshStandardMaterial({color:0x333333,roughness:0.9})
      );
      floor.rotation.x=-Math.PI/2;
      scene.add(floor);

      // Player
      player=new THREE.Mesh(
        new THREE.CylinderGeometry(0.5,0.5,1,16),
        new THREE.MeshStandardMaterial({color:0x00ff00})
      );
      player.position.y=0.5;
      player.position.z=10;
      scene.add(player);

      // Boss
      boss=new THREE.Mesh(
        new THREE.BoxGeometry(3,3,3),
        new THREE.MeshStandardMaterial({color:0xff00ff,emissive:0x440044})
      );
      boss.position.set(0,1.5,-10);
      scene.add(boss);

      // Input
      window.addEventListener('keydown',onKeyDown);
      window.addEventListener('keyup',onKeyUp);
      window.addEventListener('mousemove',onMouseMove);
      window.addEventListener('mousedown',shoot);
      gameOverDiv.onclick=restart;
      victoryDiv.onclick=restart;

      animate();
    }

    function onKeyDown(e){ const k=e.key.toLowerCase(); if(['w','a','s','d'].includes(k)) keys[k]=true; if(e.code==='Space'&&!jumping){ velocityY=0.4; jumping=true;} }
    function onKeyUp(e){ const k=e.key.toLowerCase(); if(['w','a','s','d'].includes(k)) keys[k]=false; }
    function onMouseMove(e){ mouse.x=(e.clientX/window.innerWidth)*2-1; mouse.y=-(e.clientY/window.innerHeight)*2+1; }

    function shoot(){ if(!canShoot||gameOver||victory)return; canShoot=false;
      const b=new THREE.Mesh(new THREE.SphereGeometry(0.15,8,8),new THREE.MeshStandardMaterial({color:0xffff00}));
      b.position.copy(player.position);
      // Aim dir
      raycaster.setFromCamera(mouse,camera);
      const pts=raycaster.intersectObject(floor);
      if(pts.length) aimPoint.copy(pts[0].point);
      else aimPoint.set(player.position.x,0,player.position.z-1);
      const dir=new THREE.Vector3().subVectors(aimPoint,player.position).setY(0).normalize();
      b.direction=dir;
      bullets.push(b); scene.add(b);
      setTimeout(()=>canShoot=true,shootCD);
    }

    function bossDash(){ // dash toward player
      const dir=new THREE.Vector3().subVectors(player.position,boss.position).setY(0).normalize();
      boss.position.addScaledVector(dir,15);
      // small scale pulse
      const start=Date.now(); const dur=300;
      (function pulse(){ const t=Date.now()-start;
        const s=1+0.3*Math.sin((t/dur)*Math.PI*2);
        boss.scale.set(s,s,s);
        if(t<dur) requestAnimationFrame(pulse);
        else boss.scale.set(1,1,1);
      })();
    }

    function bossSpinAttack(){ // radial bullets
      const count=12;
      for(let i=0;i<count;i++){
        const angle=(i/count)*Math.PI*2;
        const b=new THREE.Mesh(new THREE.SphereGeometry(0.12,8,8),new THREE.MeshStandardMaterial({color:0xff0000}));
        b.position.copy(boss.position);
        b.direction=new THREE.Vector3(Math.cos(angle),0,Math.sin(angle));
        enemyBullets.push(b); scene.add(b);
      }
    }

    function animate(time=0){ requestAnimationFrame(animate);
      if(!gameOver&&!victory){
        // Player move
        let dx=0,dz=0;
        if(keys.w) dz-=0.1; if(keys.s) dz+=0.1;
        if(keys.a) dx-=0.1; if(keys.d) dx+=0.1;
        player.position.x=THREE.MathUtils.clamp(player.position.x+dx,-arenaSize,arenaSize);
        player.position.z=THREE.MathUtils.clamp(player.position.z+dz,-arenaSize,arenaSize);
        // gravity
        velocityY+=gravity; player.position.y+=velocityY;
        if(player.position.y<=0.5){ player.position.y=0.5; velocityY=0; jumping=false; }
        // aim rotate
        raycaster.setFromCamera(mouse,camera);
        const pts=raycaster.intersectObject(floor);
        if(pts.length){ aimPoint.copy(pts[0].point);
          player.rotation.y=Math.atan2(aimPoint.x-player.position.x,aimPoint.z-player.position.z);
        }

        // bullet updates
        bullets.forEach((b,i)=>{
          b.position.addScaledVector(b.direction,0.5);
          if(b.position.length()>100){ scene.remove(b); bullets.splice(i,1); return; }
          if(b.position.distanceTo(boss.position)<1.5){
            // hit
            bossHealth-=5; uiBossHP.textContent=bossHealth;
            score+=5; uiScore.textContent=score;
            scene.remove(b); bullets.splice(i,1);
            if(bossHealth<=0){ victory=true; victoryDiv.style.display='block'; }
          }
        });

        // boss behavior
        // chase
        const toPlayer=new THREE.Vector3().subVectors(player.position,boss.position);
        toPlayer.y=0;
        if(toPlayer.length()>5){ boss.position.addScaledVector(toPlayer.normalize(),0.02); }
        // attacks
        if(time-lastShoot>1000){ // shoot single bullet
          const b=new THREE.Mesh(new THREE.SphereGeometry(0.12,8,8),new THREE.MeshStandardMaterial({color:0x9900ff}));
          b.position.copy(boss.position);
          b.direction=toPlayer.normalize(); enemyBullets.push(b); scene.add(b);
          lastShoot=time;
        }
        if(time-lastDash>5000){ bossDash(); lastDash=time; }
        if(time-lastSpin>8000){ bossSpinAttack(); lastSpin=time; }

        // enemyBullets
        enemyBullets.forEach((b,i)=>{
          b.position.addScaledVector(b.direction,0.3);
          if(b.position.length()>100){ scene.remove(b); enemyBullets.splice(i,1); return; }
          if(b.position.distanceTo(player.position)<0.6){
            health--; uiHealth.textContent=health;
            scene.remove(b); enemyBullets.splice(i,1);
            if(health<=0){ gameOver=true; gameOverDiv.style.display='block'; }
          }
        });
      }
      renderer.render(scene,camera);
    }

    function restart(){
      // reset
      health=3; bossHealth=50; score=0; gameOver=false; victory=false;
      uiHealth.textContent=health; uiBossHP.textContent=bossHealth; uiScore.textContent=score;
      gameOverDiv.style.display='none'; victoryDiv.style.display='none';
      // reset pos
      player.position.set(0,0.5,10); boss.position.set(0,1.5,-10);
      // clear bullets
      bullets.forEach(b=>scene.remove(b)); bullets=[];
      enemyBullets.forEach(b=>scene.remove(b)); enemyBullets=[];
    }

    init();
  </script>
</body>
</html>
